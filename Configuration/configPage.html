<div id="AINewsletterConfigPage" data-role="page" class="page type-interior pluginConfigurationPage AINewsletterConfigPage withTabs" data-require="emby-checkbox,emby-input,emby-select">
    <div data-role="content">
        <div class="content-primary">
            <form id="AINewsletterConfigForm">

                <!-- AI Configuration Section -->
                <div class="verticalSection">
                    <div class="sectionTitleContainer flex align-items-center">
                        <h2 class="sectionTitle">AI Configuration</h2>
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel" for="AIProvider">AI Provider:</label>
                        <select is="emby-select" class="emby-select-withcolor" id="AIProvider" name="AIProvider">
                            <option value="OpenAI">OpenAI</option>
                            <option value="Anthropic">Anthropic</option>
                            <option value="Custom">Custom API</option>
                        </select>
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel" for="AIApiKey">API Key:</label>
                        <input is="emby-input" type="password" id="AIApiKey" name="AIApiKey" class="emby-input" />
                        <div class="fieldDescription">Your API key for the selected AI provider</div>
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel" for="AIModel">Model:</label>
                        <input is="emby-input" type="text" id="AIModel" name="AIModel" class="emby-input" />
                        <div class="fieldDescription">AI model to use for content generation (e.g., gpt-4o-mini)</div>
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel" for="AIBaseUrl">Base URL:</label>
                        <input is="emby-input" type="url" id="AIBaseUrl" name="AIBaseUrl" class="emby-input" />
                        <div class="fieldDescription">API endpoint URL</div>
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel" for="NewsletterTone">Newsletter Tone:</label>
                        <select is="emby-select" class="emby-select-withcolor" id="NewsletterTone" name="NewsletterTone">
                            <option value="friendly">Friendly</option>
                            <option value="professional">Professional</option>
                            <option value="casual">Casual</option>
                            <option value="enthusiastic">Enthusiastic</option>
                            <option value="cinephile">Movie Buff</option>
                        </select>
                    </div>

                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label class="emby-checkbox-label">
                            <input is="emby-checkbox" type="checkbox" id="EnablePersonalization" name="EnablePersonalization" />
                            <span>Enable personalized recommendations</span>
                        </label>
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel" for="CustomPromptAdditions">Custom Prompt Additions:</label>
                        <textarea is="emby-input" id="CustomPromptAdditions" name="CustomPromptAdditions" class="emby-input" rows="3"></textarea>
                        <div class="fieldDescription">Additional instructions for the AI</div>
                    </div>
                </div>

                <!-- Email Configuration Section -->
                <div class="verticalSection">
                    <div class="sectionTitleContainer flex align-items-center">
                        <h2 class="sectionTitle">Email Configuration</h2>
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel" for="SmtpServer">SMTP Server:</label>
                        <input is="emby-input" type="text" id="SmtpServer" name="SmtpServer" class="emby-input" />
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel" for="SmtpPort">SMTP Port:</label>
                        <input is="emby-input" type="number" id="SmtpPort" name="SmtpPort" class="emby-input" />
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel" for="SmtpUsername">SMTP Username:</label>
                        <input is="emby-input" type="text" id="SmtpUsername" name="SmtpUsername" class="emby-input" />
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel" for="SmtpPassword">SMTP Password:</label>
                        <input is="emby-input" type="password" id="SmtpPassword" name="SmtpPassword" class="emby-input" />
                    </div>

                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label class="emby-checkbox-label">
                            <input is="emby-checkbox" type="checkbox" id="SmtpUseSsl" name="SmtpUseSsl" />
                            <span>Use SSL/TLS</span>
                        </label>
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel" for="SenderEmail">Sender Email:</label>
                        <input is="emby-input" type="email" id="SenderEmail" name="SenderEmail" class="emby-input" />
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel" for="SenderName">Sender Name:</label>
                        <input is="emby-input" type="text" id="SenderName" name="SenderName" class="emby-input" />
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel" for="Recipients">Recipients (one per line):</label>
                        <textarea is="emby-input" id="Recipients" name="Recipients" class="emby-input" rows="4"></textarea>
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel" for="EmailSubjectTemplate">Email Subject Template:</label>
                        <input is="emby-input" type="text" id="EmailSubjectTemplate" name="EmailSubjectTemplate" class="emby-input" />
                        <div class="fieldDescription">Use {ItemCount} for number of new items</div>
                    </div>
                </div>

                <!-- Content Configuration Section -->
                <div class="verticalSection">
                    <div class="sectionTitleContainer flex align-items-center">
                        <h2 class="sectionTitle">Content Configuration</h2>
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel" for="ScheduleIntervalHours">Schedule Interval (hours):</label>
                        <input is="emby-input" type="number" id="ScheduleIntervalHours" name="ScheduleIntervalHours" class="emby-input" min="1" />
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel" for="DaysBackToScan">Days Back to Scan:</label>
                        <input is="emby-input" type="number" id="DaysBackToScan" name="DaysBackToScan" class="emby-input" min="1" />
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel" for="MaxItemsPerNewsletter">Max Items per Newsletter:</label>
                        <input is="emby-input" type="number" id="MaxItemsPerNewsletter" name="MaxItemsPerNewsletter" class="emby-input" min="1" />
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel" for="ContentTypes">Content Types (comma-separated):</label>
                        <input is="emby-input" type="text" id="ContentTypes" name="ContentTypes" class="emby-input" />
                        <div class="fieldDescription">Types: Movie, Series, Season, Episode, MusicAlbum, Audio, Book</div>
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel" for="IncludedLibraries">Included Libraries (comma-separated):</label>
                        <input is="emby-input" type="text" id="IncludedLibraries" name="IncludedLibraries" class="emby-input" />
                        <div class="fieldDescription">Leave empty for all libraries</div>
                    </div>
                </div>

                <!-- Image Configuration Section -->
                <div class="verticalSection">
                    <div class="sectionTitleContainer flex align-items-center">
                        <h2 class="sectionTitle">Image Configuration</h2>
                    </div>

                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label class="emby-checkbox-label">
                            <input is="emby-checkbox" type="checkbox" id="IncludePosters" name="IncludePosters" />
                            <span>Include posters in newsletters</span>
                        </label>
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel" for="PosterHostingType">Poster Hosting:</label>
                        <select is="emby-select" class="emby-select-withcolor" id="PosterHostingType" name="PosterHostingType">
                            <option value="JellyfinAPI">Jellyfin API</option>
                            <option value="Imgur">Imgur</option>
                        </select>
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel" for="ImgurClientId">Imgur Client ID:</label>
                        <input is="emby-input" type="text" id="ImgurClientId" name="ImgurClientId" class="emby-input" />
                        <div class="fieldDescription">Required if using Imgur hosting</div>
                    </div>
                </div>

                <!-- Advanced Settings -->
                <div class="verticalSection">
                    <div class="sectionTitleContainer flex align-items-center">
                        <h2 class="sectionTitle">Advanced Settings</h2>
                    </div>

                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label class="emby-checkbox-label">
                            <input is="emby-checkbox" type="checkbox" id="EnableScheduledTask" name="EnableScheduledTask" />
                            <span>Enable scheduled newsletter generation</span>
                        </label>
                    </div>
                </div>

                <div>
                    <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                        <span>Save</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script type="text/javascript">
(function () {
    var AINewsletterConfig = {
        pluginUniqueId: '8B0B7F7A-3F8C-4F5D-9C2A-1E5F8B7A3C4D'
    };

    function loadConfig(page) {
        Dashboard.showLoadingMsg();

        ApiClient.getPluginConfiguration(AINewsletterConfig.pluginUniqueId).then(function (config) {
            page.querySelector('#AIProvider').value = config.AIProvider || 'OpenAI';
            page.querySelector('#AIApiKey').value = config.AIApiKey || '';
            page.querySelector('#AIModel').value = config.AIModel || 'gpt-4o-mini';
            page.querySelector('#AIBaseUrl').value = config.AIBaseUrl || 'https://api.openai.com/v1';
            page.querySelector('#NewsletterTone').value = config.NewsletterTone || 'friendly';
            page.querySelector('#EnablePersonalization').checked = config.EnablePersonalization !== false;
            page.querySelector('#CustomPromptAdditions').value = config.CustomPromptAdditions || '';

            page.querySelector('#SmtpServer').value = config.SmtpServer || '';
            page.querySelector('#SmtpPort').value = config.SmtpPort || 587;
            page.querySelector('#SmtpUsername').value = config.SmtpUsername || '';
            page.querySelector('#SmtpPassword').value = config.SmtpPassword || '';
            page.querySelector('#SmtpUseSsl').checked = config.SmtpUseSsl !== false;
            page.querySelector('#SenderEmail').value = config.SenderEmail || '';
            page.querySelector('#SenderName').value = config.SenderName || 'Jellyfin AI Newsletter';
            page.querySelector('#Recipients').value = (config.Recipients || []).join('\n');
            page.querySelector('#EmailSubjectTemplate').value = config.EmailSubjectTemplate || '🎬 Your Weekly Jellyfin Update - {ItemCount} New Items';

            page.querySelector('#ScheduleIntervalHours').value = config.ScheduleIntervalHours || 24;
            page.querySelector('#DaysBackToScan').value = config.DaysBackToScan || 7;
            page.querySelector('#MaxItemsPerNewsletter').value = config.MaxItemsPerNewsletter || 10;
            page.querySelector('#ContentTypes').value = (config.ContentTypes || ['Movie', 'Series', 'MusicAlbum']).join(',');
            page.querySelector('#IncludedLibraries').value = (config.IncludedLibraries || []).join(',');

            page.querySelector('#IncludePosters').checked = config.IncludePosters !== false;
            page.querySelector('#PosterHostingType').value = config.PosterHostingType || 'JellyfinAPI';
            page.querySelector('#ImgurClientId').value = config.ImgurClientId || '';

            page.querySelector('#EnableScheduledTask').checked = config.EnableScheduledTask !== false;

            Dashboard.hideLoadingMsg();
        });
    }

    function saveConfig(page) {
        Dashboard.showLoadingMsg();

        var config = {
            AIProvider: page.querySelector('#AIProvider').value,
            AIApiKey: page.querySelector('#AIApiKey').value,
            AIModel: page.querySelector('#AIModel').value,
            AIBaseUrl: page.querySelector('#AIBaseUrl').value,
            NewsletterTone: page.querySelector('#NewsletterTone').value,
            EnablePersonalization: page.querySelector('#EnablePersonalization').checked,
            CustomPromptAdditions: page.querySelector('#CustomPromptAdditions').value,

            SmtpServer: page.querySelector('#SmtpServer').value,
            SmtpPort: parseInt(page.querySelector('#SmtpPort').value) || 587,
            SmtpUsername: page.querySelector('#SmtpUsername').value,
            SmtpPassword: page.querySelector('#SmtpPassword').value,
            SmtpUseSsl: page.querySelector('#SmtpUseSsl').checked,
            SenderEmail: page.querySelector('#SenderEmail').value,
            SenderName: page.querySelector('#SenderName').value,
            Recipients: page.querySelector('#Recipients').value.split('\n').filter(function(email) { return email.trim(); }),
            EmailSubjectTemplate: page.querySelector('#EmailSubjectTemplate').value,

            ScheduleIntervalHours: parseInt(page.querySelector('#ScheduleIntervalHours').value) || 24,
            DaysBackToScan: parseInt(page.querySelector('#DaysBackToScan').value) || 7,
            MaxItemsPerNewsletter: parseInt(page.querySelector('#MaxItemsPerNewsletter').value) || 10,
            ContentTypes: page.querySelector('#ContentTypes').value.split(',').map(function(s) { return s.trim(); }).filter(function(s) { return s; }),
            IncludedLibraries: page.querySelector('#IncludedLibraries').value.split(',').map(function(s) { return s.trim(); }).filter(function(s) { return s; }),

            IncludePosters: page.querySelector('#IncludePosters').checked,
            PosterHostingType: page.querySelector('#PosterHostingType').value,
            ImgurClientId: page.querySelector('#ImgurClientId').value,

            EnableScheduledTask: page.querySelector('#EnableScheduledTask').checked
        };

        ApiClient.updatePluginConfiguration(AINewsletterConfig.pluginUniqueId, config).then(function (result) {
            Dashboard.processPluginConfigurationUpdateResult(result);
        });
    }

    window.AINewsletterConfigPage = {
        loadConfig: loadConfig,
        saveConfig: saveConfig
    };

    pageIdOn('pageinit', "AINewsletterConfigPage", function () {
        var page = this;

        page.querySelector('#AINewsletterConfigForm').addEventListener('submit', function (e) {
            saveConfig(page);
            e.preventDefault();
            return false;
        });
    });

    pageIdOn('pageshow', "AINewsletterConfigPage", function () {
        loadConfig(this);
    });

})();
</script>